<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - O.P. Veteran</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .component-card { transition: all 0.2s ease-in-out; }
        .component-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.15); }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">

    <!-- Login Section -->
    <div id="auth-container" class="max-w-md mx-auto mt-20 p-8 bg-gray-800 rounded-lg shadow-xl">
        <h1 class="text-3xl font-bold text-center mb-6 text-yellow-400">Admin Login</h1>
        <form id="login-form" class="space-y-4">
            <input type="email" id="email" placeholder="Email" class="w-full bg-gray-700 p-3 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-yellow-500" autocomplete="email">
            <input type="password" id="password" placeholder="Password" class="w-full bg-gray-700 p-3 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-yellow-500" autocomplete="current-password">
            <button type="submit" class="w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-3 rounded-lg transition">Login</button>
        </form>
        <p id="auth-error" class="text-red-500 mt-4 text-center"></p>
    </div>

    <!-- Admin Panel -->
    <div id="admin-panel" class="hidden container mx-auto p-4 md:p-8">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-4xl font-bold text-yellow-400">Website Editor</h1>
            <button id="logout-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Logout</button>
        </div>
        
        <div class="mb-8">
            <label for="page-selector" class="block text-lg font-medium mb-2">Editing Page:</label>
            <select id="page-selector" class="w-full md:w-1/2 bg-gray-700 p-3 rounded-lg border border-gray-600">
                <option value="home">Home</option>
                <option value="garrison-retreats">Garrison Retreats</option>
                <option value="get-involved">Get Involved</option>
                <option value="mental-health">Mental Health</option>
                <option value="op-vetfest">O.P. Vetfest</option>
                <option value="volunteer">Volunteer</option>
                <option value="store">Store</option>
                <option value="calendar">Calendar</option>
                <option value="checkout">Checkout</option>
                <option value="privacy-policy">Privacy Policy</option>
            </select>
        </div>

        <div id="page-components-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <!-- Component cards will be rendered here -->
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b border-gray-700">
                <h2 id="modal-title" class="text-2xl font-bold text-yellow-400">Edit Component</h2>
                <button id="close-modal-btn" class="text-gray-400 hover:text-white text-3xl">&times;</button>
            </div>
            <div id="modal-body" class="p-6 overflow-y-auto">
                <!-- Editor fields will be injected here -->
            </div>
            <div class="p-4 bg-gray-900 border-t border-gray-700 flex justify-end">
                <button id="save-component-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        const firebaseConfig = {
            apiKey: "AIzaSyAznsT6i5H0DJ6-X2FK5ZuBOHwiP2vfgCQ",
            authDomain: "opveteran-website-v2.firebaseapp.com",
            projectId: "opveteran-website-v2",
            storageBucket: "opveteran-website-v2.appspot.com",
            messagingSenderId: "759648723714",
            appId: "1:759648723714:web:99d9a4b77e4e994a2fd81b",
            measurementId: "G-ZW9XEGYGKR"
        };
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- AUTH LOGIC ---
        const authContainer = document.getElementById('auth-container');
        const adminPanel = document.getElementById('admin-panel');
        const loginForm = document.getElementById('login-form');
        const authError = document.getElementById('auth-error');
        const logoutButton = document.getElementById('logout-button');

        onAuthStateChanged(auth, user => {
            if (user) {
                authContainer.classList.add('hidden');
                adminPanel.classList.remove('hidden');
                loadPageComponents();
            } else {
                authContainer.classList.remove('hidden');
                adminPanel.classList.add('hidden');
            }
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            authError.textContent = 'Logging in...';
            try {
                await signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value);
                authError.textContent = '';
            } catch (error) {
                authError.textContent = "Login failed. Please check your credentials.";
            }
        });

        logoutButton.addEventListener('click', () => signOut(auth));

        // --- PAGE EDITOR LOGIC ---
        const pageSelector = document.getElementById('page-selector');
        const componentsContainer = document.getElementById('page-components-container');
        let currentPageData = {};

        async function loadPageComponents() {
            const pageId = pageSelector.value;
            componentsContainer.innerHTML = '<p>Loading components...</p>';
            try {
                const pageRef = doc(db, 'pages', pageId);
                const pageSnap = await getDoc(pageRef);
                if (pageSnap.exists()) {
                    currentPageData = pageSnap.data();
                    renderComponentCards();
                } else {
                    componentsContainer.innerHTML = `<p>No data found for this page. Run the setup script.</p>`;
                }
            } catch (error) {
                componentsContainer.innerHTML = `<p class="text-red-500">Error loading page data: ${error.message}</p>`;
            }
        }
        
        function renderComponentCards() {
            componentsContainer.innerHTML = '';
            if(!currentPageData) return;
            Object.keys(currentPageData).forEach(componentKey => {
                const component = currentPageData[componentKey];
                const card = document.createElement('div');
                card.className = 'component-card bg-gray-800 p-6 rounded-lg shadow-lg cursor-pointer';
                card.dataset.key = componentKey;
                
                let preview = 'No preview available.';
                if(component.title) preview = `<p class="text-gray-400">${component.title}</p>`;
                if(component.heading) preview = `<p class="text-gray-400">${component.heading}</p>`;
                
                card.innerHTML = `
                    <h3 class="text-xl font-bold text-yellow-400 mb-2 capitalize">${componentKey.replace(/([A-Z])/g, ' $1')}</h3>
                    ${preview}
                `;
                card.addEventListener('click', () => openEditModal(componentKey));
                componentsContainer.appendChild(card);
            });
        }

        pageSelector.addEventListener('change', loadPageComponents);

        // --- MODAL LOGIC ---
        const editModal = document.getElementById('edit-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const saveComponentBtn = document.getElementById('save-component-btn');
        let currentEditingKey = null;

        function openEditModal(componentKey) {
            currentEditingKey = componentKey;
            const componentData = currentPageData[componentKey];
            modalTitle.textContent = `Edit ${componentKey.replace(/([A-Z])/g, ' $1')}`;
            modalBody.innerHTML = '';
            
            Object.keys(componentData).forEach(fieldKey => {
                const value = componentData[fieldKey];
                
                if (Array.isArray(value)) {
                    // Handle arrays of objects (like team members, pillars, partners)
                    let arrayHtml = `<h4 class="text-lg font-semibold mb-2 capitalize">${fieldKey.replace(/([A-Z])/g, ' $1')}</h4>`;
                    value.forEach((item, index) => {
                        arrayHtml += `<div class="bg-gray-700 p-3 rounded mb-3">`;
                        Object.keys(item).forEach(itemKey => {
                            arrayHtml += `<label class="block text-sm font-medium mt-2">${itemKey}</label>
                                         <input type="text" data-array-key="${fieldKey}" data-index="${index}" data-item-key="${itemKey}" value="${item[itemKey]}" class="w-full bg-gray-600 p-2 rounded border border-gray-500">`;
                        });
                        arrayHtml += `</div>`;
                    });
                    modalBody.innerHTML += arrayHtml;
                } else {
                    const fieldDiv = document.createElement('div');
                    fieldDiv.className = 'mb-4';
                    let fieldInput = `<label class="block text-sm font-medium mb-1 capitalize">${fieldKey.replace(/([A-Z])/g, ' $1')}</label>`;
                    
                    if (fieldKey.toLowerCase().includes('imageurl')) {
                        fieldInput += `<input type="text" data-key="${fieldKey}" value="${value}" class="w-full bg-gray-700 p-2 rounded border border-gray-600">
                                     <img src="${value}" class="mt-2 max-w-xs rounded bg-gray-700">`;
                    } else if (value.length > 80) {
                         fieldInput += `<textarea data-key="${fieldKey}" class="w-full h-32 bg-gray-700 p-2 rounded border border-gray-600">${value}</textarea>`;
                    } else {
                        fieldInput += `<input type="text" data-key="${fieldKey}" value="${value}" class="w-full bg-gray-700 p-2 rounded border border-gray-600">`;
                    }
                    fieldDiv.innerHTML = fieldInput;
                    modalBody.appendChild(fieldDiv);
                }
            });
            editModal.classList.remove('hidden');
        }

        closeModalBtn.addEventListener('click', () => editModal.classList.add('hidden'));

        saveComponentBtn.addEventListener('click', async () => {
             if (!currentEditingKey) return;
             
             // Update simple fields
             modalBody.querySelectorAll('input[data-key], textarea[data-key]').forEach(input => {
                 currentPageData[currentEditingKey][input.dataset.key] = input.value;
             });

             // Update array fields
             modalBody.querySelectorAll('input[data-array-key]').forEach(input => {
                const { arrayKey, index, itemKey } = input.dataset;
                currentPageData[currentEditingKey][arrayKey][parseInt(index)][itemKey] = input.value;
             });

            const pageId = pageSelector.value;
            try {
                await setDoc(doc(db, 'pages', pageId), currentPageData);
                alert('Component saved successfully!');
                editModal.classList.add('hidden');
                renderComponentCards(); // Refresh the cards
            } catch (error) {
                alert('Error saving component: ' + error.message);
            }
        });
    </script>
</body>
</html>

