<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - O.P. Veteran</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto:wght@400;700&family=Open+Sans:wght@400;700&family=Lato:wght@400;700&family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .sidebar-link.active { background-color: #ca8a04; color: #1f2937; }
        .content-block-item.active { background-color: #374151; }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">

    <!-- Login Section -->
    <div id="auth-container" class="max-w-md mx-auto mt-20 p-8 bg-gray-800 rounded-lg shadow-xl">
        <h1 class="text-3xl font-bold text-center mb-6 text-yellow-400">Admin Login</h1>
        <form id="login-form" class="space-y-4">
            <input type="email" id="email" placeholder="Email" class="w-full bg-gray-700 p-3 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-yellow-500" autocomplete="email">
            <input type="password" id="password" placeholder="Password" class="w-full bg-gray-700 p-3 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-yellow-500" autocomplete="current-password">
            <button type="submit" class="w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-3 rounded-lg transition">Login</button>
        </form>
        <p id="auth-error" class="text-red-500 mt-4 text-center"></p>
    </div>

    <!-- Admin Panel Section -->
    <div id="admin-panel" class="hidden flex h-screen">
        <!-- Sidebar -->
        <aside class="w-1/4 bg-gray-800 p-6 flex flex-col">
            <div class="flex-shrink-0">
                <h1 class="text-3xl font-bold text-yellow-400 mb-8">Admin Menu</h1>
            </div>
            <nav id="sidebar-nav" class="flex-grow overflow-y-auto pr-2">
                <!-- Links will be generated here -->
            </nav>
            <div class="flex-shrink-0 mt-auto">
                 <button id="logout-button" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg">Logout</button>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="w-3/4 p-10 overflow-y-auto">
            <div id="editor-container">
                <h2 class="text-4xl font-bold text-gray-500">Select an item from the sidebar to begin editing.</h2>
            </div>
        </main>
    </div>
    
    <!-- Firebase SDK -->
    <script type="module">
        const firebaseConfig = {
            apiKey: "AIzaSyAznsT6i5H0DJ6-X2FK5ZuBOHwiP2vfgCQ",
            authDomain: "opveteran-website-v2.firebaseapp.com",
            projectId: "opveteran-website-v2",
            storageBucket: "opveteran-website-v2.appspot.com",
            messagingSenderId: "759648723714",
            appId: "1:759648723714:web:99d9a4b77e4e994a2fd81b",
            measurementId: "G-ZW9XEGYGKR"
        };
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const authContainer = document.getElementById('auth-container');
        const adminPanel = document.getElementById('admin-panel');
        const loginForm = document.getElementById('login-form');
        const authError = document.getElementById('auth-error');
        const logoutButton = document.getElementById('logout-button');
        const sidebarNav = document.getElementById('sidebar-nav');
        const editorContainer = document.getElementById('editor-container');
        
        let websiteData = {};

        onAuthStateChanged(auth, user => {
            if (user) {
                authContainer.classList.add('hidden');
                adminPanel.classList.remove('flex');
                adminPanel.classList.add('flex');
                loadAllData();
            } else {
                authContainer.classList.remove('hidden');
                adminPanel.classList.add('hidden');
                adminPanel.classList.remove('flex');
            }
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            authError.textContent = '';
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                authError.textContent = "Failed to login. Check email and password.";
            }
        });

        logoutButton.addEventListener('click', () => signOut(auth));

        async function loadAllData() {
            try {
                // Load Pages
                const pagesSnapshot = await getDocs(collection(db, 'pages'));
                websiteData.pages = {};
                pagesSnapshot.forEach(doc => {
                    websiteData.pages[doc.id] = doc.data();
                });

                // Load Global Settings
                const settingsSnap = await getDoc(doc(db, 'settings', 'global'));
                if (settingsSnap.exists()) {
                    websiteData.settings = settingsSnap.data();
                } else {
                    websiteData.settings = { fontFamily: "'Inter', sans-serif", primaryColor: '#f59e0b' };
                }
                
                buildSidebar();

            } catch (error) {
                editorContainer.innerHTML = `<h2 class="text-2xl text-red-500">Error: Could not load website data. ${error.message}</h2>`;
            }
        }
        
        function buildSidebar() {
            sidebarNav.innerHTML = '';
            
            // Global Settings Link
            const settingsDiv = document.createElement('div');
            settingsDiv.innerHTML = `<button data-type="settings" class="sidebar-link w-full text-left font-bold text-xl py-3 px-4 rounded-lg transition hover:bg-gray-700">Global Settings</button>`;
            sidebarNav.appendChild(settingsDiv);

            // Pages Section
            const pagesHeader = document.createElement('h3');
            pagesHeader.className = "text-gray-400 font-bold mt-6 mb-2 uppercase text-sm";
            pagesHeader.textContent = "Pages";
            sidebarNav.appendChild(pagesHeader);

            Object.keys(websiteData.pages).forEach(pageId => {
                const pageData = websiteData.pages[pageId];
                const pageContainer = document.createElement('div');
                
                const pageButton = document.createElement('button');
                pageButton.className = 'sidebar-link w-full text-left font-bold text-lg py-2 px-4 rounded-lg transition hover:bg-gray-700 flex justify-between items-center';
                pageButton.dataset.pageId = pageId;
                pageButton.innerHTML = `<span>${pageId.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</span> <i class="fas fa-chevron-down fa-xs transition-transform"></i>`;
                
                const blocksList = document.createElement('div');
                blocksList.className = 'pl-4 mt-2 hidden space-y-1';

                (pageData.content || []).forEach((block, index) => {
                    const blockItem = document.createElement('button');
                    blockItem.className = 'content-block-item w-full text-left text-gray-300 py-2 px-3 rounded-md hover:bg-gray-600 block';
                    blockItem.dataset.pageId = pageId;
                    blockItem.dataset.blockIndex = index;
                    blockItem.textContent = `Block ${index + 1}: ${block.type}`;
                    blocksList.appendChild(blockItem);
                });

                pageButton.addEventListener('click', () => {
                    blocksList.classList.toggle('hidden');
                    pageButton.querySelector('i').classList.toggle('rotate-180');
                });
                
                pageContainer.appendChild(pageButton);
                pageContainer.appendChild(blocksList);
                sidebarNav.appendChild(pageContainer);
            });
            
            // Add event listeners for all links
            sidebarNav.querySelectorAll('button').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopPropagation();
                    sidebarNav.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');

                    if (button.dataset.type === 'settings') {
                        renderSettingsEditor();
                    } else if(button.dataset.blockIndex) {
                        const { pageId, blockIndex } = button.dataset;
                        renderBlockEditor(pageId, parseInt(blockIndex));
                    }
                });
            });
        }
        
        function renderSettingsEditor() {
            editorContainer.innerHTML = `
                <div class="bg-gray-800 p-8 rounded-lg">
                    <h2 class="text-3xl font-bold mb-8">Global Website Settings</h2>
                    <div class="space-y-6">
                        <div>
                            <label for="font-selector" class="block text-lg font-medium mb-2">Website Font Family</label>
                            <select id="font-selector" class="w-full md:w-1/2 bg-gray-700 p-3 rounded-lg border border-gray-600">
                                <option value="'Inter', sans-serif">Inter</option>
                                <option value="'Roboto', sans-serif">Roboto</option>
                                <option value="'Open Sans', sans-serif">Open Sans</option>
                                <option value="'Lato', sans-serif">Lato</option>
                                <option value="'Montserrat', sans-serif">Montserrat</option>
                            </select>
                        </div>
                         <div>
                            <label for="primary-color" class="block text-lg font-medium mb-2">Primary Accent Color</label>
                            <input type="color" id="primary-color" class="p-1 h-12 w-24 block bg-gray-700 border border-gray-600 cursor-pointer rounded-lg">
                        </div>
                    </div>
                    <button id="save-settings-btn" class="mt-8 bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-3 px-6 rounded-lg">Save Global Settings</button>
                </div>`;
                
            document.getElementById('font-selector').value = websiteData.settings.fontFamily;
            document.getElementById('primary-color').value = websiteData.settings.primaryColor;
            
            document.getElementById('save-settings-btn').addEventListener('click', async () => {
                const newSettings = {
                    fontFamily: document.getElementById('font-selector').value,
                    primaryColor: document.getElementById('primary-color').value,
                };
                try {
                    await setDoc(doc(db, 'settings', 'global'), newSettings);
                    websiteData.settings = newSettings; // Update local data
                    alert('Settings saved successfully!');
                } catch(error) {
                    alert('Error saving settings: ' + error.message);
                }
            });
        }

        function renderBlockEditor(pageId, index) {
            const block = websiteData.pages[pageId].content[index];
            let editorHtml = '';

             if (block.type === 'text') {
                editorHtml = `<h3 class="text-xl font-bold mb-4">Text / HTML Content</h3><textarea id="block-editor-textarea" class="w-full h-96 bg-gray-900 p-4 rounded border border-gray-600 font-mono text-sm">${block.htmlContent || ''}</textarea>`;
            } else if (block.type === 'image') {
                editorHtml = `<h3 class="text-xl font-bold mb-4">Image Block</h3><label class="block text-sm font-medium mb-1">Image URL:</label><input id="block-editor-input" type="text" value="${block.imageUrl || ''}" class="w-full bg-gray-700 p-2 rounded border border-gray-600"><img src="${block.imageUrl || 'https://placehold.co/200x100'}" class="mt-4 max-w-sm rounded">`;
            } else if (block.type === 'video') {
                 editorHtml = `<h3 class="text-xl font-bold mb-4">Video Block</h3><label class="block text-sm font-medium mb-1">YouTube Embed URL:</label><input id="block-editor-input" type="text" value="${block.videoUrl || ''}" class="w-full bg-gray-700 p-2 rounded border border-gray-600"><div class="relative mt-4" style="padding-top: 56.25%;"><iframe class="absolute top-0 left-0 w-full h-full" src="${block.videoUrl || ''}" allowfullscreen></iframe></div>`;
            }

            editorContainer.innerHTML = `
                <div class="bg-gray-800 p-8 rounded-lg">
                    <h2 class="text-3xl font-bold mb-6">Editing Block ${index + 1} on <span class="capitalize text-yellow-400">${pageId.replace(/-/g, ' ')}</span></h2>
                    ${editorHtml}
                    <div class="mt-6 flex justify-between items-center">
                        <button id="save-block-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg">Save Block</button>
                        <button id="remove-block-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Delete Block</button>
                    </div>
                </div>`;
            
            document.getElementById('save-block-btn').addEventListener('click', async () => {
                const content = block.type === 'text' ? document.getElementById('block-editor-textarea').value : document.getElementById('block-editor-input').value;
                 if (block.type === 'text') {
                    websiteData.pages[pageId].content[index].htmlContent = content;
                } else if (block.type === 'image') {
                    websiteData.pages[pageId].content[index].imageUrl = content;
                } else if (block.type === 'video') {
                    websiteData.pages[pageId].content[index].videoUrl = content;
                }
                
                try {
                    await setDoc(doc(db, 'pages', pageId), websiteData.pages[pageId]);
                    alert('Block saved successfully!');
                    loadAllData(); // Refresh sidebar and data
                } catch(error) {
                     alert('Error saving block: ' + error.message);
                }
            });
            
            document.getElementById('remove-block-btn').addEventListener('click', async () => {
                if (confirm('Are you sure you want to delete this block? This cannot be undone.')) {
                    websiteData.pages[pageId].content.splice(index, 1);
                     try {
                        await setDoc(doc(db, 'pages', pageId), websiteData.pages[pageId]);
                        alert('Block deleted successfully!');
                        editorContainer.innerHTML = '<h2 class="text-2xl text-gray-500">Select another item to edit.</h2>';
                        loadAllData(); // Refresh sidebar and data
                    } catch(error) {
                         alert('Error deleting block: ' + error.message);
                    }
                }
            });
        }
    </script>
</body>
</html>

